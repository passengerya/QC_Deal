# QC Excel 处理程序

## 最新更新（2026-02-12）

- 已移除界面底部提示文字，界面更简洁。
- 程序窗口新增作者署名：`by YRZ`（标题栏与右上角）。
- 已清理历史乱码注释与默认模板文案，统一为可读中文。
- UI 风格升级为“细腻动效 + 鲜活配色”：
  - 按钮悬停/按下微交互（提亮、微位移、回弹）
  - 输入框焦点高亮
  - 窗口淡入过渡
  - 圆角卡片、柔和阴影、渐变背景与高饱和点缀色
- `qc_tool.ps1` 已补充结构化注释，便于后续维护。
- 修复按钮样式参数类型问题（避免启动时报 `textColor` 转换异常）。

## 运行方式

方式一：直接双击 `qc_tool.exe`（推荐）。

方式二：运行脚本：

```powershell
powershell -ExecutionPolicy Bypass -File .\qc_tool.ps1
```

## 重新打包（从脚本生成 EXE）

```powershell
Invoke-ps2exe -inputFile ".\qc_tool.ps1" -outputFile ".\qc_tool.exe" -noConsole -STA -title "QC Excel 处理" -product "QC Excel Tool" -company "YRZ" -version "1.0.2.0"
```

## 目录结构

- `qc_export/`：待处理数据（`.xls`）
- `templet.xls`：输出模板
- `exclude.txt`：排除关键词（逗号分隔）
- `qc_config.json`：配置文件（自动生成）
- `output/`：输出目录

## UI 字段说明

- 仪器（A 列）：输入后可保存为下拉选项。
- 正常水平批号（B 列）：可输入/保存，支持模板。
- 异常水平批号（C 列）：可输入/保存，支持模板。
- 批号模板：下拉选择或自定义保存，支持设为默认与删除。
- 缺失处理：
  - `留空`：缺失日期不填值。
  - `均值填充`：用“最接近均值的原始值”填充缺失日期。

## 数据处理规则

1. **文件名时间范围**
   - 文件名包含 `YYYYMMDD-YYYYMMDD`，表示数据来源时间范围。

2. **第一列日期格式**
   - 第一列可能是完整日期，也可能是当月日期（例如 `1` 代表当月 1 号）。
   - 程序会根据文件名时间范围推断具体日期。

3. **按日期对齐**
   - 程序会构建“期望日期序列”。
   - 按日期对齐填入数据，缺失日期留空或均值填充（按你选择的模式）。

4. **写入顺序**
   - D 列先写“正常”数据块，再写“异常”数据块。
   - 每个日期对应一行数据。

5. **输出命名**
   - 输出文件名：
     `仪器_时间范围(正常批号_异常批号).xls`
   - 例：`BS-800_20260101-0131(常规化学202501_常规化学202502).xls`

## 配置文件 qc_config.json

程序会自动生成并维护以下配置（均会去重保存）：

```json
{
  "instruments": ["..."],
  "batches": ["..."],
  "batch_templates": ["常规化学{year}{value}", "..."],
  "batch_template_selected": "当前选中模板",
  "batch_template_default": "默认模板",
  "exclude_keywords": ["Anti-HCV", "HBsAg", "..."]
}
```

说明：
- `exclude_keywords` 优先于 `exclude.txt`。
- 如果配置中为空，会回退读取 `exclude.txt`。

## 缺失数据提示

当发现“文件名日期范围”与“实际日期数量”不一致时，会提示：
- 缺失日期列表
- 超出日期列表（如果有）

## 实现原理（简要）

1. 使用 Excel COM 读取 `.xls`（无需额外库）。
2. 根据文件名生成日期范围；结合第一列日期（支持 `1..31`）完成日期归一化。
3. 以 `yyyy-MM-dd` 作为日期键建立映射，保证按日期对齐。
4. 缺失处理：
   - `留空`：写空值
   - `均值填充`：选取最接近均值的原始值
5. 使用模板写入 A-E 列并保存为新文件。

## 依赖

- 本机需安装 Excel（通过 COM 方式读写 `.xls`）。









